// src/flow.lark

// UPDATED: A Flow script can now contain statements OR test_blocks
?start: (statement | test_block)+

// NEW: Definition for a test block
test_block: "test" STRING "{" statement* "}"

// UPDATED: A statement can now also be an assertion
?statement: schema_decl | source_decl | sink_decl | assignment | execution | assert_statement

// NEW: Definition for an assert statement
assert_statement: "assert" bool_expression ";"

schema_decl: "schema" NAME "{" (field_decl)* "}"
field_decl:  NAME ":" TYPE ";"
TYPE: "string" | "int" | "float" | "bool"

source_decl: "source" NAME "<-" function_call ("using" NAME)? ";"
sink_decl:   "sink" NAME "->" function_call ";"

assignment: NAME "=" (pipeline | join_expr) ";"
execution:  pipeline ";"

pipeline: NAME (pipe_step)*
pipe_step: "->" (transformation | NAME)

// --- TRANSFORMATIONS & EXPRESSIONS ---
transformation: filter | select | sort | mutate | group_by | aggregate
filter: "filter" "(" bool_expression ")"
select: "select" "(" NAME ("," NAME)* ")"
sort:   "sort" "(" NAME ("," NAME)* ("," "order" ":" STRING)? ")"
mutate: "mutate" "(" mutate_expr ("," mutate_expr)* ")"
group_by: "group_by" "(" NAME ("," NAME)* ")"
aggregate: "aggregate" "(" agg_expr ("," agg_expr)* ")"
agg_expr: NAME "=" agg_function
agg_function: AGG_FUNC_NAME "(" NAME? ")"

join_expr: "join" "(" NAME "," NAME "," "on" ":" join_condition ")"
join_condition: column_ref "==" column_ref

bool_expression: arith_expr (BOOL_OPERATOR arith_expr)*
?arith_expr: term ((PLUS | MINUS) term)*
?term: factor ((STAR | SLASH) factor)*
?factor: (SIGNED_NUMBER | STRING | column_ref | "(" arith_expr ")")

column_ref: NAME "." NAME
mutate_expr: NAME "=" arith_expr

BOOL_OPERATOR: ">" | "<" | "==" | "!="
function_call: NAME "(" arguments? ")"
env_var: "env" "(" STRING ")"
?arguments: (NAME ":" (STRING | SIGNED_NUMBER | env_var) ("," NAME ":" (STRING | SIGNED_NUMBER | env_var))*)

// --- TERMINALS ---
NAME:   /[a-zA-Z_]\w*/
STRING: /"[^"]*"|'[^']*'/
COMMENT: /\/\/[^\n]*/
AND:    "and"
OR:     "or"
PLUS:   "+"
MINUS:  "-"
STAR:   "*"
SLASH:  "/"
AGG_FUNC_NAME: "count" | "sum" | "avg" | "mean" | "min" | "max"

// --- IGNORE RULES ---
%import common.WS
%import common.SIGNED_NUMBER
%ignore WS
%ignore COMMENT